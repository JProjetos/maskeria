name: Atualizar versão online

on:
  workflow_dispatch:
    inputs:
      core_version:
        description: 'Versão do Core que disparou o update'
        required: false
        default: ''

jobs:
  update-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout com submódulo
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Atualizar submódulo core
        run: |
          git submodule update --remote --merge core
          if git diff --name-only HEAD | grep -q "core"; then
            echo "true" > .core_updated
          else
            echo "false" > .core_updated
          fi

      - name: Incrementar patch com base no core
        run: |
          CORE_VERSION_FILE=core/VERSION
          ONLINE_VERSION_FILE=VERSION
          LAST_CORE_FILE=.last_core_version
          CORE_UPDATED_FILE=.core_updated
          HAS_CHANGED=false

          CORE_UPDATED=$(cat $CORE_UPDATED_FILE)

          CORE_VERSION=$(cat $CORE_VERSION_FILE | awk '{print $2}')
          INPUT_CORE_VERSION="${{ github.event.inputs.core_version }}"
          if [ -n "$INPUT_CORE_VERSION" ]; then
            CORE_VERSION="$INPUT_CORE_VERSION"
          fi

          ONLINE_CODENAME="Ataraxia"
          if [ -f $ONLINE_VERSION_FILE ]; then
            ONLINE_CODENAME=$(cat $ONLINE_VERSION_FILE | awk '{print $1}')
            ONLINE_VERSION=$(cat $ONLINE_VERSION_FILE | awk '{print $2}')
            IFS='.' read -r X Y Z <<< "$ONLINE_VERSION"
          else
            X=0
            Y=0
            Z=0
          fi

          if [ -f $LAST_CORE_FILE ]; then
            LAST_CORE_VERSION=$(cat $LAST_CORE_FILE)
          else
            LAST_CORE_VERSION=""
          fi

          if [ "$CORE_UPDATED" = "true" ] || [ "$CORE_VERSION" != "$LAST_CORE_VERSION" ]; then
            Z=$((Z+1))
            HAS_CHANGED=true
            echo $CORE_VERSION > $LAST_CORE_FILE
          fi

          NEW_VERSION="$ONLINE_CODENAME $X.$Y.$Z"

          if [ "$HAS_CHANGED" = true ]; then
            echo $NEW_VERSION > $ONLINE_VERSION_FILE
            if [ "$CORE_UPDATED" = "true" ]; then
              git add core
            fi
            git add $ONLINE_VERSION_FILE $LAST_CORE_FILE
            git commit -m "Atualizando versão online para '$NEW_VERSION'"
            git push origin HEAD
          fi
          
          rm -f $CORE_UPDATED_FILE
