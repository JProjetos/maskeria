name: Deploy GH Pages com subm√≥dulo build

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [game-release]
  workflow_dispatch:

# C√≥digo gerado por https://chat.deepseek.com
# Revis√£o realizada por https://chatgpt.com

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: main-repo

      - name: Atualizar subm√≥dulo na main (apenas em game-release)
        if: github.event_name == 'repository_dispatch'
        run: |
          cd main-repo
          cd game
          git fetch origin
          git checkout ${{ github.event.client_payload.commit_hash }}
          cd ..
          git add game
          git commit -m "Atualizar subm√≥dulo para ${{ github.event.client_payload.commit_hash }}"
          git push origin main

          git fetch origin
          git reset --hard origin/main

      - name: Obter commit do subm√≥dulo
        id: get-submodule-commit
        run: |
          cd main-repo
          COMMIT_HASH=$(git ls-tree HEAD game | awk '{print $3}')
          echo "üìå Commit do subm√≥dulo na main: $COMMIT_HASH"
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT

      - name: Build do jogo
        run: |
          HASH="${{ steps.get-submodule-commit.outputs.hash }}"
          echo "üî® Build do jogo no commit: $HASH"
          
          # Clonar o jogo no commit espec√≠fico
          git clone https://github.com/JProjetos/maskeria-game.git game-build
          cd game-build
          git checkout $HASH
          
          cd ..

      - name: Checkout gh-pages
        run: |
          git clone --branch gh-pages --single-branch https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} gh-pages-branch || \
          (git init gh-pages-branch && cd gh-pages-branch && git checkout --orphan gh-pages)

      - name: Sincronizar gh-pages com main
        run: |
          cd gh-pages-branch
          
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} +
          
          cp -r ../main-repo/* .
          cp -r ../main-repo/.??* . 2>/dev/null || true
          
          # Remover a pasta game (que cont√©m apenas a refer√™ncia do subm√≥dulo)
          rm -rf game

      - name: Incluir build do jogo
        run: |
          cd gh-pages-branch
          
          mkdir -p game
          cp -r ../game-build/* game/

      - name: Commit e push para gh-pages
        run: |
          cd gh-pages-branch
          git add .
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Sem mudan√ßas para commit"
          else
            git commit -m "Deploy - main sync + game build ${{ steps.get-submodule-commit.outputs.hash }}"
            git push origin gh-pages --force
            echo "‚úÖ Deploy realizado com sucesso!"
          fi